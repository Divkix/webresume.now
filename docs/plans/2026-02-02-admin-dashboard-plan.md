# Admin Dashboard Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a read-only admin dashboard with 5 pages (Overview, Users, Resumes, Analytics, Referrals) for platform monitoring.

**Architecture:** Add `isAdmin` boolean to user table, create admin auth helper, build sidebar-based layout under `app/(admin)/admin/`, with 5 API routes under `app/api/admin/` for data fetching.

**Tech Stack:** Next.js 16 App Router, Drizzle ORM, D1 (SQLite), Tailwind CSS, Lucide icons, uPlot charts.

---

## Task 1: Database Migration

**Files:**
- Modify: `lib/db/schema.ts:8-50`
- Create: `migrations/00XX_add_is_admin.sql` (generated by Drizzle)

**Step 1: Add isAdmin field to schema**

Edit `lib/db/schema.ts`, add after line 44 (after `referralCount`):

```typescript
    // Admin flag for admin dashboard access
    isAdmin: integer("is_admin", { mode: "boolean" }).notNull().default(false),
```

**Step 2: Generate migration**

Run: `bun run db:generate`

Expected: New migration file created in `migrations/` folder.

**Step 3: Apply migration locally**

Run: `bun run db:migrate`

Expected: Migration applied successfully.

**Step 4: Verify schema**

Run: `bunx wrangler d1 execute webresume-db --local --command "PRAGMA table_info(user)"`

Expected: `is_admin` column appears in output.

**Step 5: Commit**

```bash
git add lib/db/schema.ts migrations/
git commit -m "$(cat <<'EOF'
feat(db): add isAdmin field to user table

Add boolean flag for admin dashboard access control.
Default false for all users.
EOF
)"
```

---

## Task 2: Admin Auth Helper

**Files:**
- Create: `lib/auth/admin.ts`
- Modify: `lib/auth/middleware.ts` (add export)

**Step 1: Create admin auth helper**

Create `lib/auth/admin.ts`:

```typescript
import { getCloudflareContext } from "@opennextjs/cloudflare";
import { eq } from "drizzle-orm";
import { redirect } from "next/navigation";
import { getDb } from "@/lib/db";
import { user as users } from "@/lib/db/schema";
import { getServerSession } from "./session";

export interface AdminUser {
  id: string;
  email: string;
  name: string;
  isAdmin: boolean;
}

/**
 * Server-side admin auth check for pages.
 * Redirects to / if not logged in, /dashboard if not admin.
 */
export async function requireAdminAuth(): Promise<AdminUser> {
  const session = await getServerSession();

  if (!session?.user) {
    redirect("/");
  }

  const { env } = await getCloudflareContext({ async: true });
  const db = getDb(env.DB);

  const dbUser = await db.query.user.findFirst({
    where: eq(users.id, session.user.id),
    columns: {
      id: true,
      email: true,
      name: true,
      isAdmin: true,
    },
  });

  if (!dbUser) {
    redirect("/");
  }

  if (!dbUser.isAdmin) {
    redirect("/dashboard");
  }

  return dbUser as AdminUser;
}

/**
 * API route admin auth check.
 * Returns user or error Response.
 */
export async function requireAdminAuthForApi(): Promise<
  { user: AdminUser; error: null } | { user: null; error: Response }
> {
  const session = await getServerSession();

  if (!session?.user) {
    return {
      user: null,
      error: Response.json({ error: "Unauthorized" }, { status: 401 }),
    };
  }

  const { env } = await getCloudflareContext({ async: true });
  const db = getDb(env.DB);

  const dbUser = await db.query.user.findFirst({
    where: eq(users.id, session.user.id),
    columns: {
      id: true,
      email: true,
      name: true,
      isAdmin: true,
    },
  });

  if (!dbUser) {
    return {
      user: null,
      error: Response.json({ error: "User not found" }, { status: 401 }),
    };
  }

  if (!dbUser.isAdmin) {
    return {
      user: null,
      error: Response.json({ error: "Admin access required" }, { status: 403 }),
    };
  }

  return { user: dbUser as AdminUser, error: null };
}
```

**Step 2: Verify TypeScript compiles**

Run: `bun run type-check`

Expected: No errors.

**Step 3: Commit**

```bash
git add lib/auth/admin.ts
git commit -m "$(cat <<'EOF'
feat(auth): add admin auth helpers

- requireAdminAuth() for pages (redirects non-admins)
- requireAdminAuthForApi() for API routes (returns error response)
EOF
)"
```

---

## Task 3: Admin Layout Shell

**Files:**
- Create: `app/(admin)/admin/layout.tsx`
- Create: `components/admin/AdminSidebar.tsx`
- Create: `components/admin/AdminHeader.tsx`

**Step 1: Create AdminSidebar component**

Create `components/admin/AdminSidebar.tsx`:

```typescript
"use client";

import {
  BarChart3,
  FileText,
  LayoutDashboard,
  Share2,
  Users,
  X,
} from "lucide-react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { Logo } from "@/components/Logo";

interface AdminSidebarProps {
  isOpen: boolean;
  onClose: () => void;
  adminEmail: string;
}

const NAV_ITEMS = [
  { name: "Overview", href: "/admin", icon: LayoutDashboard, exact: true },
  { name: "Users", href: "/admin/users", icon: Users, exact: false },
  { name: "Resumes", href: "/admin/resumes", icon: FileText, exact: false },
  { name: "Analytics", href: "/admin/analytics", icon: BarChart3, exact: false },
  { name: "Referrals", href: "/admin/referrals", icon: Share2, exact: false },
];

export function AdminSidebar({ isOpen, onClose, adminEmail }: AdminSidebarProps) {
  const pathname = usePathname();

  const isActive = (href: string, exact: boolean) => {
    if (exact) return pathname === href;
    return pathname?.startsWith(href);
  };

  return (
    <>
      {/* Mobile backdrop */}
      {isOpen && (
        <div
          className="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 lg:hidden"
          onClick={onClose}
          aria-hidden="true"
        />
      )}

      {/* Sidebar */}
      <aside
        className={`
          fixed top-0 left-0 h-full w-64 bg-white border-r border-slate-200/60
          flex flex-col z-50 transition-transform duration-300
          ${isOpen ? "translate-x-0" : "-translate-x-full"}
          lg:translate-x-0
        `}
        aria-label="Admin navigation"
      >
        {/* Mobile close button */}
        <button
          type="button"
          onClick={onClose}
          className="absolute top-4 right-4 p-2 text-slate-600 hover:text-slate-900 lg:hidden transition-colors"
          aria-label="Close navigation"
        >
          <X size={20} />
        </button>

        {/* Logo Header */}
        <div className="p-4 border-b border-slate-200/60">
          <Link href="/" aria-label="webresume.now home">
            <Logo size="xs" />
          </Link>
          <span className="ml-2 text-xs font-medium text-slate-500 bg-slate-100 px-2 py-0.5 rounded">
            Admin
          </span>
        </div>

        {/* Navigation */}
        <nav className="flex-1 p-4 space-y-1" role="navigation">
          {NAV_ITEMS.map((item) => {
            const Icon = item.icon;
            const active = isActive(item.href, item.exact);

            return (
              <Link
                key={item.href}
                href={item.href}
                onClick={onClose}
                className={`
                  flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium
                  transition-all duration-200
                  ${
                    active
                      ? "bg-slate-100 text-slate-900 border-l-2 border-coral"
                      : "text-slate-600 hover:bg-slate-50 hover:text-slate-900"
                  }
                `}
                aria-current={active ? "page" : undefined}
              >
                <Icon size={20} aria-hidden="true" />
                <span>{item.name}</span>
              </Link>
            );
          })}
        </nav>

        {/* Admin Info */}
        <div className="p-4 border-t border-slate-200/60">
          <p className="text-xs text-slate-500">Logged in as</p>
          <p className="text-sm font-medium text-slate-700 truncate">{adminEmail}</p>
        </div>
      </aside>
    </>
  );
}
```

**Step 2: Create AdminHeader component**

Create `components/admin/AdminHeader.tsx`:

```typescript
"use client";

import { ArrowLeft, Menu, RefreshCw } from "lucide-react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";

interface AdminHeaderProps {
  onMenuClick: () => void;
}

const PAGE_TITLES: Record<string, string> = {
  "/admin": "Overview",
  "/admin/users": "Users",
  "/admin/resumes": "Resumes",
  "/admin/analytics": "Analytics",
  "/admin/referrals": "Referrals",
};

export function AdminHeader({ onMenuClick }: AdminHeaderProps) {
  const pathname = usePathname();
  const router = useRouter();

  const title = PAGE_TITLES[pathname] || "Admin";

  const handleRefresh = () => {
    router.refresh();
  };

  return (
    <header className="sticky top-0 z-10 bg-white/80 backdrop-blur-sm border-b border-slate-200/60">
      <div className="flex items-center justify-between h-14 px-4 lg:px-6">
        <div className="flex items-center gap-3">
          {/* Mobile menu button */}
          <button
            type="button"
            onClick={onMenuClick}
            className="p-2 -ml-2 text-slate-600 hover:text-slate-900 lg:hidden transition-colors"
            aria-label="Open menu"
          >
            <Menu size={20} />
          </button>

          <h1 className="text-lg font-semibold text-slate-900">{title}</h1>
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            onClick={handleRefresh}
            className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors"
            aria-label="Refresh data"
          >
            <RefreshCw size={16} aria-hidden="true" />
            <span className="hidden sm:inline">Refresh</span>
          </button>

          <Link
            href="/dashboard"
            className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors"
          >
            <ArrowLeft size={16} aria-hidden="true" />
            <span className="hidden sm:inline">Back to Dashboard</span>
          </Link>
        </div>
      </div>
    </header>
  );
}
```

**Step 3: Create admin layout**

Create `app/(admin)/admin/layout.tsx`:

```typescript
import { AdminLayoutClient } from "./layout-client";
import { requireAdminAuth } from "@/lib/auth/admin";

export const runtime = "edge";

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const admin = await requireAdminAuth();

  return <AdminLayoutClient adminEmail={admin.email}>{children}</AdminLayoutClient>;
}
```

**Step 4: Create admin layout client component**

Create `app/(admin)/admin/layout-client.tsx`:

```typescript
"use client";

import { useState } from "react";
import { AdminHeader } from "@/components/admin/AdminHeader";
import { AdminSidebar } from "@/components/admin/AdminSidebar";

interface AdminLayoutClientProps {
  children: React.ReactNode;
  adminEmail: string;
}

export function AdminLayoutClient({ children, adminEmail }: AdminLayoutClientProps) {
  const [sidebarOpen, setSidebarOpen] = useState(false);

  return (
    <div className="min-h-screen bg-cream">
      <AdminSidebar
        isOpen={sidebarOpen}
        onClose={() => setSidebarOpen(false)}
        adminEmail={adminEmail}
      />

      <div className="lg:pl-64">
        <AdminHeader onMenuClick={() => setSidebarOpen(true)} />

        <main className="p-4 lg:p-6">
          <a href="#main-content" className="sr-only focus:not-sr-only">
            Skip to main content
          </a>
          <div id="main-content">{children}</div>
        </main>
      </div>
    </div>
  );
}
```

**Step 5: Verify TypeScript compiles**

Run: `bun run type-check`

Expected: No errors.

**Step 6: Commit**

```bash
git add app/\(admin\)/ components/admin/
git commit -m "$(cat <<'EOF'
feat(admin): add admin layout shell with sidebar navigation

- AdminSidebar with nav links and mobile drawer
- AdminHeader with refresh button and back link
- Layout with requireAdminAuth() protection
EOF
)"
```

---

## Task 4: Admin Stats API

**Files:**
- Create: `app/api/admin/stats/route.ts`

**Step 1: Create stats API route**

Create `app/api/admin/stats/route.ts`:

```typescript
/**
 * GET /api/admin/stats
 *
 * Returns overview statistics for admin dashboard.
 */

import { getCloudflareContext } from "@opennextjs/cloudflare";
import { count, eq, gte, isNotNull, sql } from "drizzle-orm";
import { requireAdminAuthForApi } from "@/lib/auth/admin";
import { getDb } from "@/lib/db";
import { pageViews, resumes, siteData, user } from "@/lib/db/schema";

export const runtime = "edge";

export async function GET() {
  const { error } = await requireAdminAuthForApi();
  if (error) return error;

  try {
    const { env } = await getCloudflareContext({ async: true });
    const db = getDb(env.DB);

    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();

    const [
      userStats,
      resumeStats,
      viewsToday,
      recentSignups,
      dailyViews,
    ] = await Promise.all([
      // User counts
      db
        .select({
          total: count(),
          withSiteData: sql<number>`SUM(CASE WHEN EXISTS (SELECT 1 FROM site_data WHERE site_data.user_id = user.id) THEN 1 ELSE 0 END)`,
        })
        .from(user),

      // Resume status counts
      db
        .select({
          status: resumes.status,
          count: count(),
        })
        .from(resumes)
        .groupBy(resumes.status),

      // Views today
      db
        .select({ count: count() })
        .from(pageViews)
        .where(gte(pageViews.createdAt, todayStart)),

      // Recent signups (last 10)
      db
        .select({
          email: user.email,
          createdAt: user.createdAt,
        })
        .from(user)
        .orderBy(sql`${user.createdAt} DESC`)
        .limit(10),

      // Daily views for sparkline (last 7 days)
      db
        .select({
          date: sql<string>`DATE(${pageViews.createdAt})`.as("date"),
          views: count(),
        })
        .from(pageViews)
        .where(gte(pageViews.createdAt, sevenDaysAgo))
        .groupBy(sql`DATE(${pageViews.createdAt})`)
        .orderBy(sql`DATE(${pageViews.createdAt})`),
    ]);

    // Process resume stats
    const resumeStatusMap = resumeStats.reduce(
      (acc, r) => {
        acc[r.status || "unknown"] = r.count;
        return acc;
      },
      {} as Record<string, number>,
    );

    const processingResumes =
      (resumeStatusMap.processing || 0) + (resumeStatusMap.queued || 0);
    const failedResumes = resumeStatusMap.failed || 0;

    // Fill missing dates for sparkline
    const filledDailyViews = fillMissingDates(dailyViews, 7);

    return Response.json({
      totalUsers: userStats[0]?.total ?? 0,
      publishedResumes: userStats[0]?.withSiteData ?? 0,
      processingResumes,
      viewsToday: viewsToday[0]?.count ?? 0,
      failedResumes,
      recentSignups: recentSignups.map((u) => ({
        email: u.email,
        createdAt: u.createdAt,
      })),
      dailyViews: filledDailyViews,
    });
  } catch (err) {
    console.error("[admin/stats] Error:", err);
    return Response.json({ error: "Failed to fetch stats" }, { status: 500 });
  }
}

function fillMissingDates(
  data: Array<{ date: string; views: number }>,
  days: number,
): Array<{ date: string; views: number }> {
  const dataMap = new Map(data.map((d) => [d.date, d.views]));
  const result: Array<{ date: string; views: number }> = [];

  for (let i = days - 1; i >= 0; i--) {
    const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000)
      .toISOString()
      .slice(0, 10);
    result.push({ date, views: dataMap.get(date) ?? 0 });
  }

  return result;
}
```

**Step 2: Verify TypeScript compiles**

Run: `bun run type-check`

Expected: No errors.

**Step 3: Commit**

```bash
git add app/api/admin/stats/
git commit -m "$(cat <<'EOF'
feat(api): add admin stats endpoint

Returns overview metrics: user counts, resume status,
views today, recent signups, 7-day sparkline data.
EOF
)"
```

---

## Task 5: Overview Page

**Files:**
- Create: `app/(admin)/admin/page.tsx`
- Create: `components/admin/StatCard.tsx`
- Create: `components/admin/AdminSparkline.tsx`

**Step 1: Create StatCard component**

Create `components/admin/StatCard.tsx`:

```typescript
import type { LucideIcon } from "lucide-react";

interface StatCardProps {
  title: string;
  value: string | number;
  icon: LucideIcon;
  iconColorClass: string;
  iconBgClass: string;
  change?: number;
  href?: string;
}

export function StatCard({
  title,
  value,
  icon: Icon,
  iconColorClass,
  iconBgClass,
  change,
  href,
}: StatCardProps) {
  const content = (
    <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-4 hover:shadow-depth-md hover:-translate-y-0.5 transition-all duration-300">
      <div className="flex items-center gap-3">
        <div className="relative shrink-0">
          <div
            className={`absolute inset-0 ${iconBgClass} rounded-lg blur-md opacity-20`}
          />
          <div className={`relative ${iconBgClass} p-2.5 rounded-lg`}>
            <Icon className={`w-5 h-5 ${iconColorClass}`} aria-hidden="true" />
          </div>
        </div>
        <div className="min-w-0 flex-1">
          <p className="text-xs font-medium text-slate-500 truncate">{title}</p>
          <div className="flex items-baseline gap-2">
            <p
              className="text-xl font-bold text-slate-900"
              style={{ fontVariantNumeric: "tabular-nums" }}
            >
              {typeof value === "number" ? value.toLocaleString() : value}
            </p>
            {change !== undefined && (
              <span
                className={`text-xs font-medium ${
                  change >= 0 ? "text-emerald-600" : "text-red-600"
                }`}
              >
                {change >= 0 ? "+" : ""}
                {change}%
              </span>
            )}
          </div>
        </div>
      </div>
    </div>
  );

  if (href) {
    return (
      <a href={href} className="block">
        {content}
      </a>
    );
  }

  return content;
}
```

**Step 2: Create AdminSparkline component**

Create `components/admin/AdminSparkline.tsx`:

```typescript
"use client";

import { useEffect, useRef, useState } from "react";
import uPlot from "uplot";
import "uplot/dist/uPlot.min.css";

interface AdminSparklineProps {
  data: Array<{ date: string; views: number }>;
}

export function AdminSparkline({ data }: AdminSparklineProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const chartRef = useRef<uPlot | null>(null);
  const [width, setWidth] = useState(0);

  useEffect(() => {
    const el = containerRef.current;
    if (!el) return;

    const ro = new ResizeObserver((entries) => {
      for (const entry of entries) {
        if (entry.contentRect.width > 0) {
          setWidth(Math.floor(entry.contentRect.width));
        }
      }
    });
    ro.observe(el);
    return () => ro.disconnect();
  }, []);

  useEffect(() => {
    const el = containerRef.current;
    if (!el || width <= 0 || data.length === 0) return;

    if (chartRef.current) {
      chartRef.current.destroy();
      chartRef.current = null;
    }

    const timestamps = data.map(
      (d) => new Date(`${d.date}T00:00:00`).getTime() / 1000,
    );
    const views = data.map((d) => d.views);

    const opts: uPlot.Options = {
      width,
      height: 80,
      padding: [8, 4, 0, 0],
      legend: { show: false },
      cursor: { show: false },
      series: [
        {},
        {
          stroke: "#6366f1",
          width: 2,
          fill: "rgba(99, 102, 241, 0.1)",
          paths: uPlot.paths.spline?.() ?? undefined,
        },
      ],
      axes: [{ show: false }, { show: false }],
    };

    chartRef.current = new uPlot(opts, [timestamps, views], el);

    return () => {
      if (chartRef.current) {
        chartRef.current.destroy();
        chartRef.current = null;
      }
    };
  }, [width, data]);

  return <div ref={containerRef} className="w-full" style={{ height: 80 }} />;
}
```

**Step 3: Create Overview page**

Create `app/(admin)/admin/page.tsx`:

```typescript
import {
  AlertTriangle,
  Eye,
  FileText,
  Loader2,
  Users,
} from "lucide-react";
import Link from "next/link";
import { AdminSparkline } from "@/components/admin/AdminSparkline";
import { StatCard } from "@/components/admin/StatCard";
import { requireAdminAuth } from "@/lib/auth/admin";
import { getCloudflareContext } from "@opennextjs/cloudflare";
import { count, eq, gte, sql } from "drizzle-orm";
import { getDb } from "@/lib/db";
import { pageViews, resumes, siteData, user } from "@/lib/db/schema";

export const runtime = "edge";

async function getStats() {
  const { env } = await getCloudflareContext({ async: true });
  const db = getDb(env.DB);

  const now = new Date();
  const todayStart = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
  ).toISOString();
  const sevenDaysAgo = new Date(
    now.getTime() - 7 * 24 * 60 * 60 * 1000,
  ).toISOString();

  const [userCount, siteDataCount, resumeStats, viewsToday, recentSignups, dailyViews] =
    await Promise.all([
      db.select({ count: count() }).from(user),
      db.select({ count: count() }).from(siteData),
      db
        .select({ status: resumes.status, count: count() })
        .from(resumes)
        .groupBy(resumes.status),
      db
        .select({ count: count() })
        .from(pageViews)
        .where(gte(pageViews.createdAt, todayStart)),
      db
        .select({ email: user.email, name: user.name, createdAt: user.createdAt })
        .from(user)
        .orderBy(sql`${user.createdAt} DESC`)
        .limit(10),
      db
        .select({
          date: sql<string>`DATE(${pageViews.createdAt})`.as("date"),
          views: count(),
        })
        .from(pageViews)
        .where(gte(pageViews.createdAt, sevenDaysAgo))
        .groupBy(sql`DATE(${pageViews.createdAt})`)
        .orderBy(sql`DATE(${pageViews.createdAt})`),
    ]);

  const statusMap = resumeStats.reduce(
    (acc, r) => {
      acc[r.status || "unknown"] = r.count;
      return acc;
    },
    {} as Record<string, number>,
  );

  // Fill missing dates
  const filledDaily: Array<{ date: string; views: number }> = [];
  for (let i = 6; i >= 0; i--) {
    const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000)
      .toISOString()
      .slice(0, 10);
    const existing = dailyViews.find((d) => d.date === date);
    filledDaily.push({ date, views: existing?.views ?? 0 });
  }

  return {
    totalUsers: userCount[0]?.count ?? 0,
    publishedResumes: siteDataCount[0]?.count ?? 0,
    processingResumes: (statusMap.processing || 0) + (statusMap.queued || 0),
    failedResumes: statusMap.failed || 0,
    viewsToday: viewsToday[0]?.count ?? 0,
    recentSignups,
    dailyViews: filledDaily,
  };
}

function formatRelativeTime(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffHours / 24);

  if (diffHours < 1) return "just now";
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

export default async function AdminOverviewPage() {
  await requireAdminAuth();
  const stats = await getStats();

  return (
    <div className="space-y-6">
      {/* Stat Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <StatCard
          title="Total Users"
          value={stats.totalUsers}
          icon={Users}
          iconColorClass="text-indigo-600"
          iconBgClass="bg-linear-to-r from-indigo-100 to-blue-100"
        />
        <StatCard
          title="Published Resumes"
          value={stats.publishedResumes}
          icon={FileText}
          iconColorClass="text-emerald-600"
          iconBgClass="bg-linear-to-r from-emerald-100 to-teal-100"
        />
        <StatCard
          title="Processing"
          value={stats.processingResumes}
          icon={Loader2}
          iconColorClass="text-amber-600"
          iconBgClass="bg-linear-to-r from-amber-100 to-orange-100"
          href="/admin/resumes?status=processing"
        />
        <StatCard
          title="Views Today"
          value={stats.viewsToday}
          icon={Eye}
          iconColorClass="text-purple-600"
          iconBgClass="bg-linear-to-r from-purple-100 to-pink-100"
        />
      </div>

      {/* Failed Resumes Alert */}
      {stats.failedResumes > 0 && (
        <Link
          href="/admin/resumes?status=failed"
          className="block bg-red-50 border border-red-200 rounded-2xl p-4 hover:bg-red-100 transition-colors"
        >
          <div className="flex items-center gap-3">
            <div className="bg-red-100 p-2 rounded-lg">
              <AlertTriangle className="w-5 h-5 text-red-600" aria-hidden="true" />
            </div>
            <div>
              <p className="font-semibold text-red-900">
                {stats.failedResumes} Failed Resume{stats.failedResumes > 1 ? "s" : ""}
              </p>
              <p className="text-sm text-red-700">Click to view details</p>
            </div>
          </div>
        </Link>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Recent Signups */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Recent Signups
          </h2>
          <div className="space-y-3">
            {stats.recentSignups.length === 0 ? (
              <p className="text-sm text-slate-500">No signups yet</p>
            ) : (
              stats.recentSignups.map((signup, i) => (
                <div
                  key={`${signup.email}-${i}`}
                  className="flex items-center justify-between text-sm"
                >
                  <div className="min-w-0 flex-1">
                    <p className="font-medium text-slate-900 truncate">
                      {signup.name || "Unnamed"}
                    </p>
                    <p className="text-slate-500 truncate">{signup.email}</p>
                  </div>
                  <span className="text-xs text-slate-400 shrink-0 ml-2">
                    {formatRelativeTime(signup.createdAt)}
                  </span>
                </div>
              ))
            )}
          </div>
        </div>

        {/* Views Sparkline */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Views (Last 7 Days)
          </h2>
          <AdminSparkline data={stats.dailyViews} />
        </div>
      </div>
    </div>
  );
}
```

**Step 4: Verify build**

Run: `bun run type-check && bun run lint`

Expected: No errors.

**Step 5: Commit**

```bash
git add app/\(admin\)/admin/page.tsx components/admin/StatCard.tsx components/admin/AdminSparkline.tsx
git commit -m "$(cat <<'EOF'
feat(admin): add overview page with stats cards and sparkline

- StatCard component with icon gradient backgrounds
- AdminSparkline using uPlot for 7-day view trend
- Recent signups list with relative timestamps
- Failed resumes alert banner
EOF
)"
```

---

## Task 6: Admin Users API

**Files:**
- Create: `app/api/admin/users/route.ts`

**Step 1: Create users API route**

Create `app/api/admin/users/route.ts`:

```typescript
/**
 * GET /api/admin/users?page=1&search=query
 *
 * Returns paginated user list with search.
 */

import { getCloudflareContext } from "@opennextjs/cloudflare";
import { count, eq, like, or, sql } from "drizzle-orm";
import { requireAdminAuthForApi } from "@/lib/auth/admin";
import { getDb } from "@/lib/db";
import { pageViews, resumes, siteData, user } from "@/lib/db/schema";

export const runtime = "edge";

const PAGE_SIZE = 25;

export async function GET(request: Request) {
  const { error } = await requireAdminAuthForApi();
  if (error) return error;

  const url = new URL(request.url);
  const page = Math.max(1, Number.parseInt(url.searchParams.get("page") || "1", 10));
  const search = url.searchParams.get("search")?.trim() || "";
  const offset = (page - 1) * PAGE_SIZE;

  try {
    const { env } = await getCloudflareContext({ async: true });
    const db = getDb(env.DB);

    // Build where clause for search
    const searchCondition = search
      ? or(
          like(user.name, `%${search}%`),
          like(user.email, `%${search}%`),
          like(user.handle, `%${search}%`),
        )
      : undefined;

    // Get total count
    const [totalResult] = await db
      .select({ count: count() })
      .from(user)
      .where(searchCondition);

    // Get users with resume status and view counts
    const users = await db
      .select({
        id: user.id,
        name: user.name,
        email: user.email,
        handle: user.handle,
        createdAt: user.createdAt,
        isPro: user.isPro,
      })
      .from(user)
      .where(searchCondition)
      .orderBy(sql`${user.createdAt} DESC`)
      .limit(PAGE_SIZE)
      .offset(offset);

    // Get resume statuses and view counts for these users
    const userIds = users.map((u) => u.id);

    if (userIds.length === 0) {
      return Response.json({
        users: [],
        total: 0,
        page,
        pageSize: PAGE_SIZE,
      });
    }

    const [resumeStatuses, viewCounts, hasSiteData] = await Promise.all([
      db
        .select({
          userId: resumes.userId,
          status: resumes.status,
        })
        .from(resumes)
        .where(sql`${resumes.userId} IN (${sql.join(userIds.map((id) => sql`${id}`), sql`, `)})`),

      db
        .select({
          userId: pageViews.userId,
          views: count(),
        })
        .from(pageViews)
        .where(sql`${pageViews.userId} IN (${sql.join(userIds.map((id) => sql`${id}`), sql`, `)})`)
        .groupBy(pageViews.userId),

      db
        .select({ userId: siteData.userId })
        .from(siteData)
        .where(sql`${siteData.userId} IN (${sql.join(userIds.map((id) => sql`${id}`), sql`, `)})`),
    ]);

    // Build lookup maps
    const resumeStatusMap = new Map<string, string>();
    for (const r of resumeStatuses) {
      // Prefer showing worst status (failed > processing > completed)
      const existing = resumeStatusMap.get(r.userId);
      if (!existing || r.status === "failed" || (r.status === "processing" && existing !== "failed")) {
        resumeStatusMap.set(r.userId, r.status || "unknown");
      }
    }

    const viewCountMap = new Map(viewCounts.map((v) => [v.userId, v.views]));
    const siteDataSet = new Set(hasSiteData.map((s) => s.userId));

    // Determine user status
    const enrichedUsers = users.map((u) => {
      let status: "live" | "processing" | "no_resume" | "failed" = "no_resume";
      const resumeStatus = resumeStatusMap.get(u.id);

      if (resumeStatus === "failed") {
        status = "failed";
      } else if (resumeStatus === "processing" || resumeStatus === "queued") {
        status = "processing";
      } else if (siteDataSet.has(u.id)) {
        status = "live";
      }

      return {
        id: u.id,
        name: u.name,
        email: u.email,
        handle: u.handle,
        status,
        views: viewCountMap.get(u.id) ?? 0,
        createdAt: u.createdAt,
        isPro: u.isPro,
      };
    });

    return Response.json({
      users: enrichedUsers,
      total: totalResult?.count ?? 0,
      page,
      pageSize: PAGE_SIZE,
    });
  } catch (err) {
    console.error("[admin/users] Error:", err);
    return Response.json({ error: "Failed to fetch users" }, { status: 500 });
  }
}
```

**Step 2: Verify TypeScript compiles**

Run: `bun run type-check`

Expected: No errors.

**Step 3: Commit**

```bash
git add app/api/admin/users/
git commit -m "$(cat <<'EOF'
feat(api): add admin users endpoint

Paginated user list with search by name/email/handle.
Includes resume status and view counts per user.
EOF
)"
```

---

## Task 7: Users Page

**Files:**
- Create: `app/(admin)/admin/users/page.tsx`
- Create: `components/admin/UserStatusBadge.tsx`
- Create: `components/admin/Pagination.tsx`

**Step 1: Create UserStatusBadge component**

Create `components/admin/UserStatusBadge.tsx`:

```typescript
type Status = "live" | "processing" | "no_resume" | "failed";

interface UserStatusBadgeProps {
  status: Status;
}

const STATUS_CONFIG: Record<Status, { label: string; className: string }> = {
  live: {
    label: "Live",
    className: "bg-emerald-100 text-emerald-700",
  },
  processing: {
    label: "Processing",
    className: "bg-amber-100 text-amber-700",
  },
  no_resume: {
    label: "No Resume",
    className: "bg-slate-100 text-slate-600",
  },
  failed: {
    label: "Failed",
    className: "bg-red-100 text-red-700",
  },
};

export function UserStatusBadge({ status }: UserStatusBadgeProps) {
  const config = STATUS_CONFIG[status];

  return (
    <span
      className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${config.className}`}
    >
      {config.label}
    </span>
  );
}
```

**Step 2: Create Pagination component**

Create `components/admin/Pagination.tsx`:

```typescript
"use client";

import { ChevronLeft, ChevronRight } from "lucide-react";

interface PaginationProps {
  currentPage: number;
  totalPages: number;
  onPageChange: (page: number) => void;
}

export function Pagination({ currentPage, totalPages, onPageChange }: PaginationProps) {
  if (totalPages <= 1) return null;

  const pages: (number | "...")[] = [];

  // Always show first page
  pages.push(1);

  // Show ellipsis if needed
  if (currentPage > 3) {
    pages.push("...");
  }

  // Show pages around current
  for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
    if (!pages.includes(i)) {
      pages.push(i);
    }
  }

  // Show ellipsis if needed
  if (currentPage < totalPages - 2) {
    pages.push("...");
  }

  // Always show last page
  if (totalPages > 1 && !pages.includes(totalPages)) {
    pages.push(totalPages);
  }

  return (
    <nav className="flex items-center justify-center gap-1" aria-label="Pagination">
      <button
        type="button"
        onClick={() => onPageChange(currentPage - 1)}
        disabled={currentPage === 1}
        className="p-2 rounded-lg text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        aria-label="Previous page"
      >
        <ChevronLeft size={16} />
      </button>

      {pages.map((page, i) =>
        page === "..." ? (
          <span key={`ellipsis-${i}`} className="px-2 text-slate-400">
            ...
          </span>
        ) : (
          <button
            key={page}
            type="button"
            onClick={() => onPageChange(page)}
            className={`min-w-[32px] h-8 px-2 rounded-lg text-sm font-medium transition-colors ${
              page === currentPage
                ? "bg-slate-900 text-white"
                : "text-slate-600 hover:bg-slate-100"
            }`}
            aria-current={page === currentPage ? "page" : undefined}
          >
            {page}
          </button>
        ),
      )}

      <button
        type="button"
        onClick={() => onPageChange(currentPage + 1)}
        disabled={currentPage === totalPages}
        className="p-2 rounded-lg text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        aria-label="Next page"
      >
        <ChevronRight size={16} />
      </button>
    </nav>
  );
}
```

**Step 3: Create Users page**

Create `app/(admin)/admin/users/page.tsx`:

```typescript
"use client";

import { Search, Users } from "lucide-react";
import Link from "next/link";
import { useCallback, useEffect, useState } from "react";
import { Pagination } from "@/components/admin/Pagination";
import { UserStatusBadge } from "@/components/admin/UserStatusBadge";
import { Skeleton } from "@/components/ui/skeleton";

interface UserData {
  id: string;
  name: string;
  email: string;
  handle: string | null;
  status: "live" | "processing" | "no_resume" | "failed";
  views: number;
  createdAt: string;
  isPro: boolean;
}

interface UsersResponse {
  users: UserData[];
  total: number;
  page: number;
  pageSize: number;
}

function formatRelativeTime(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return "Today";
  if (diffDays === 1) return "Yesterday";
  if (diffDays < 7) return `${diffDays}d ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
  return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
}

export default function AdminUsersPage() {
  const [users, setUsers] = useState<UserData[]>([]);
  const [total, setTotal] = useState(0);
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(25);
  const [search, setSearch] = useState("");
  const [searchInput, setSearchInput] = useState("");
  const [loading, setLoading] = useState(true);

  const fetchUsers = useCallback(async (p: number, s: string) => {
    setLoading(true);
    try {
      const params = new URLSearchParams({ page: p.toString() });
      if (s) params.set("search", s);

      const res = await fetch(`/api/admin/users?${params}`);
      if (!res.ok) throw new Error("Failed to fetch");

      const data: UsersResponse = await res.json();
      setUsers(data.users);
      setTotal(data.total);
      setPage(data.page);
      setPageSize(data.pageSize);
    } catch (err) {
      console.error("Failed to fetch users:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchUsers(page, search);
  }, [page, search, fetchUsers]);

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    setPage(1);
    setSearch(searchInput);
  };

  const totalPages = Math.ceil(total / pageSize);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div className="flex items-center gap-2">
          <Users className="w-5 h-5 text-slate-400" aria-hidden="true" />
          <span className="text-sm text-slate-500">
            {total.toLocaleString()} total users
          </span>
        </div>

        {/* Search */}
        <form onSubmit={handleSearch} className="relative">
          <Search
            className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"
            aria-hidden="true"
          />
          <input
            type="text"
            value={searchInput}
            onChange={(e) => setSearchInput(e.target.value)}
            placeholder="Search name, email, handle..."
            className="w-full sm:w-64 pl-9 pr-4 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
            aria-label="Search users"
          />
        </form>
      </div>

      {/* Table */}
      <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-slate-200/60 bg-slate-50/50">
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  User
                </th>
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Handle
                </th>
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Status
                </th>
                <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Views
                </th>
                <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Joined
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {loading ? (
                Array.from({ length: 5 }).map((_, i) => (
                  <tr key={i}>
                    <td className="px-4 py-3">
                      <Skeleton className="h-10 w-48" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-24" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-20" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-12 ml-auto" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-16 ml-auto" />
                    </td>
                  </tr>
                ))
              ) : users.length === 0 ? (
                <tr>
                  <td colSpan={5} className="px-4 py-8 text-center text-slate-500">
                    {search ? "No users found matching your search" : "No users yet"}
                  </td>
                </tr>
              ) : (
                users.map((user) => (
                  <tr key={user.id} className="hover:bg-slate-50/50 transition-colors">
                    <td className="px-4 py-3">
                      <div>
                        <p className="font-medium text-slate-900">
                          {user.name || "Unnamed"}
                          {user.isPro && (
                            <span className="ml-1.5 text-xs text-purple-600 font-medium">
                              PRO
                            </span>
                          )}
                        </p>
                        <p className="text-sm text-slate-500">{user.email}</p>
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      {user.handle ? (
                        <Link
                          href={`/${user.handle}`}
                          target="_blank"
                          className="text-sm text-indigo-600 hover:text-indigo-800"
                        >
                          @{user.handle}
                        </Link>
                      ) : (
                        <span className="text-sm text-slate-400">-</span>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      <UserStatusBadge status={user.status} />
                    </td>
                    <td
                      className="px-4 py-3 text-right text-sm text-slate-900"
                      style={{ fontVariantNumeric: "tabular-nums" }}
                    >
                      {user.views.toLocaleString()}
                    </td>
                    <td className="px-4 py-3 text-right text-sm text-slate-500">
                      {formatRelativeTime(user.createdAt)}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="border-t border-slate-200/60 px-4 py-3">
            <Pagination
              currentPage={page}
              totalPages={totalPages}
              onPageChange={setPage}
            />
          </div>
        )}
      </div>
    </div>
  );
}
```

**Step 4: Verify build**

Run: `bun run type-check && bun run lint`

Expected: No errors.

**Step 5: Commit**

```bash
git add app/\(admin\)/admin/users/ components/admin/UserStatusBadge.tsx components/admin/Pagination.tsx
git commit -m "$(cat <<'EOF'
feat(admin): add users page with search and pagination

- Paginated table with 25 users per page
- Search by name, email, or handle
- Status badges: Live, Processing, No Resume, Failed
- View counts with tabular-nums formatting
EOF
)"
```

---

## Task 8: Admin Resumes API

**Files:**
- Create: `app/api/admin/resumes/route.ts`

**Step 1: Create resumes API route**

Create `app/api/admin/resumes/route.ts`:

```typescript
/**
 * GET /api/admin/resumes?status=all&page=1
 *
 * Returns resume processing status breakdown.
 */

import { getCloudflareContext } from "@opennextjs/cloudflare";
import { and, count, eq, sql } from "drizzle-orm";
import { requireAdminAuthForApi } from "@/lib/auth/admin";
import { getDb } from "@/lib/db";
import { resumes, user } from "@/lib/db/schema";

export const runtime = "edge";

const PAGE_SIZE = 25;
const VALID_STATUSES = new Set(["all", "completed", "processing", "queued", "failed"]);

export async function GET(request: Request) {
  const { error } = await requireAdminAuthForApi();
  if (error) return error;

  const url = new URL(request.url);
  const page = Math.max(1, Number.parseInt(url.searchParams.get("page") || "1", 10));
  const statusFilter = url.searchParams.get("status") || "all";
  const offset = (page - 1) * PAGE_SIZE;

  if (!VALID_STATUSES.has(statusFilter)) {
    return Response.json({ error: "Invalid status filter" }, { status: 400 });
  }

  try {
    const { env } = await getCloudflareContext({ async: true });
    const db = getDb(env.DB);

    // Get status counts
    const statusCounts = await db
      .select({
        status: resumes.status,
        count: count(),
      })
      .from(resumes)
      .groupBy(resumes.status);

    const stats = {
      completed: 0,
      processing: 0,
      queued: 0,
      failed: 0,
    };

    for (const s of statusCounts) {
      if (s.status === "completed" || s.status === "waiting_for_cache") {
        stats.completed += s.count;
      } else if (s.status === "processing") {
        stats.processing += s.count;
      } else if (s.status === "queued" || s.status === "pending_claim") {
        stats.queued += s.count;
      } else if (s.status === "failed") {
        stats.failed += s.count;
      }
    }

    // Build filter condition
    let statusCondition;
    if (statusFilter === "completed") {
      statusCondition = sql`${resumes.status} IN ('completed', 'waiting_for_cache')`;
    } else if (statusFilter === "processing") {
      statusCondition = eq(resumes.status, "processing");
    } else if (statusFilter === "queued") {
      statusCondition = sql`${resumes.status} IN ('queued', 'pending_claim')`;
    } else if (statusFilter === "failed") {
      statusCondition = eq(resumes.status, "failed");
    }

    // Get total for pagination
    const [totalResult] = await db
      .select({ count: count() })
      .from(resumes)
      .where(statusCondition);

    // Get resumes with user email
    const resumeList = await db
      .select({
        id: resumes.id,
        userId: resumes.userId,
        status: resumes.status,
        retryCount: resumes.retryCount,
        totalAttempts: resumes.totalAttempts,
        lastAttemptError: resumes.lastAttemptError,
        errorMessage: resumes.errorMessage,
        queuedAt: resumes.queuedAt,
        updatedAt: resumes.updatedAt,
        createdAt: resumes.createdAt,
        userEmail: user.email,
      })
      .from(resumes)
      .leftJoin(user, eq(resumes.userId, user.id))
      .where(statusCondition)
      .orderBy(sql`${resumes.updatedAt} DESC NULLS LAST, ${resumes.createdAt} DESC`)
      .limit(PAGE_SIZE)
      .offset(offset);

    return Response.json({
      stats,
      resumes: resumeList.map((r) => ({
        id: r.id,
        userEmail: r.userEmail || "Unknown",
        status: r.status,
        retryCount: r.retryCount,
        totalAttempts: r.totalAttempts,
        lastAttemptError: r.lastAttemptError || r.errorMessage,
        updatedAt: r.updatedAt || r.createdAt,
      })),
      total: totalResult?.count ?? 0,
      page,
      pageSize: PAGE_SIZE,
    });
  } catch (err) {
    console.error("[admin/resumes] Error:", err);
    return Response.json({ error: "Failed to fetch resumes" }, { status: 500 });
  }
}
```

**Step 2: Verify TypeScript compiles**

Run: `bun run type-check`

Expected: No errors.

**Step 3: Commit**

```bash
git add app/api/admin/resumes/
git commit -m "$(cat <<'EOF'
feat(api): add admin resumes endpoint

Returns resume status breakdown with filtering.
Includes error messages and retry counts.
EOF
)"
```

---

## Task 9: Resumes Page

**Files:**
- Create: `app/(admin)/admin/resumes/page.tsx`
- Create: `components/admin/ResumeStatusBadge.tsx`

**Step 1: Create ResumeStatusBadge component**

Create `components/admin/ResumeStatusBadge.tsx`:

```typescript
type Status = string;

interface ResumeStatusBadgeProps {
  status: Status;
}

const STATUS_CONFIG: Record<string, { label: string; className: string }> = {
  completed: {
    label: "Completed",
    className: "bg-emerald-100 text-emerald-700",
  },
  waiting_for_cache: {
    label: "Completed",
    className: "bg-emerald-100 text-emerald-700",
  },
  processing: {
    label: "Processing",
    className: "bg-amber-100 text-amber-700",
  },
  queued: {
    label: "Queued",
    className: "bg-blue-100 text-blue-700",
  },
  pending_claim: {
    label: "Pending",
    className: "bg-slate-100 text-slate-600",
  },
  failed: {
    label: "Failed",
    className: "bg-red-100 text-red-700",
  },
};

export function ResumeStatusBadge({ status }: ResumeStatusBadgeProps) {
  const config = STATUS_CONFIG[status] || {
    label: status,
    className: "bg-slate-100 text-slate-600",
  };

  return (
    <span
      className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${config.className}`}
    >
      {config.label}
    </span>
  );
}
```

**Step 2: Create Resumes page**

Create `app/(admin)/admin/resumes/page.tsx`:

```typescript
"use client";

import {
  AlertTriangle,
  CheckCircle2,
  Clock,
  FileText,
  Loader2,
} from "lucide-react";
import { useCallback, useEffect, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { Pagination } from "@/components/admin/Pagination";
import { ResumeStatusBadge } from "@/components/admin/ResumeStatusBadge";
import { StatCard } from "@/components/admin/StatCard";
import { Skeleton } from "@/components/ui/skeleton";

interface ResumeData {
  id: string;
  userEmail: string;
  status: string;
  retryCount: number;
  totalAttempts: number;
  lastAttemptError: string | null;
  updatedAt: string;
}

interface ResumesResponse {
  stats: {
    completed: number;
    processing: number;
    queued: number;
    failed: number;
  };
  resumes: ResumeData[];
  total: number;
  page: number;
  pageSize: number;
}

type StatusFilter = "all" | "completed" | "processing" | "queued" | "failed";

const STATUS_OPTIONS: Array<{ value: StatusFilter; label: string }> = [
  { value: "all", label: "All" },
  { value: "completed", label: "Completed" },
  { value: "processing", label: "Processing" },
  { value: "queued", label: "Queued" },
  { value: "failed", label: "Failed" },
];

function formatRelativeTime(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return "just now";
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

export default function AdminResumesPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [data, setData] = useState<ResumesResponse | null>(null);
  const [loading, setLoading] = useState(true);
  const [expandedRow, setExpandedRow] = useState<string | null>(null);

  const statusFilter = (searchParams.get("status") as StatusFilter) || "all";
  const page = Number.parseInt(searchParams.get("page") || "1", 10);

  const fetchResumes = useCallback(async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({
        status: statusFilter,
        page: page.toString(),
      });
      const res = await fetch(`/api/admin/resumes?${params}`);
      if (!res.ok) throw new Error("Failed to fetch");
      const json: ResumesResponse = await res.json();
      setData(json);
    } catch (err) {
      console.error("Failed to fetch resumes:", err);
    } finally {
      setLoading(false);
    }
  }, [statusFilter, page]);

  useEffect(() => {
    fetchResumes();
  }, [fetchResumes]);

  const updateParams = (updates: { status?: StatusFilter; page?: number }) => {
    const params = new URLSearchParams(searchParams);
    if (updates.status !== undefined) {
      params.set("status", updates.status);
      params.set("page", "1"); // Reset page on filter change
    }
    if (updates.page !== undefined) {
      params.set("page", updates.page.toString());
    }
    router.push(`/admin/resumes?${params}`);
  };

  const totalPages = data ? Math.ceil(data.total / data.pageSize) : 0;

  return (
    <div className="space-y-6">
      {/* Stats Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <button
          type="button"
          onClick={() => updateParams({ status: "completed" })}
          className="text-left"
        >
          <StatCard
            title="Completed"
            value={data?.stats.completed ?? 0}
            icon={CheckCircle2}
            iconColorClass="text-emerald-600"
            iconBgClass="bg-linear-to-r from-emerald-100 to-teal-100"
          />
        </button>
        <button
          type="button"
          onClick={() => updateParams({ status: "processing" })}
          className="text-left"
        >
          <StatCard
            title="Processing"
            value={data?.stats.processing ?? 0}
            icon={Loader2}
            iconColorClass="text-amber-600"
            iconBgClass="bg-linear-to-r from-amber-100 to-orange-100"
          />
        </button>
        <button
          type="button"
          onClick={() => updateParams({ status: "queued" })}
          className="text-left"
        >
          <StatCard
            title="Queued"
            value={data?.stats.queued ?? 0}
            icon={Clock}
            iconColorClass="text-blue-600"
            iconBgClass="bg-linear-to-r from-blue-100 to-indigo-100"
          />
        </button>
        <button
          type="button"
          onClick={() => updateParams({ status: "failed" })}
          className="text-left"
        >
          <StatCard
            title="Failed"
            value={data?.stats.failed ?? 0}
            icon={AlertTriangle}
            iconColorClass="text-red-600"
            iconBgClass="bg-linear-to-r from-red-100 to-pink-100"
          />
        </button>
      </div>

      {/* Filter */}
      <div className="flex items-center gap-4">
        <FileText className="w-5 h-5 text-slate-400" aria-hidden="true" />
        <select
          value={statusFilter}
          onChange={(e) => updateParams({ status: e.target.value as StatusFilter })}
          className="text-sm border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500"
          aria-label="Filter by status"
        >
          {STATUS_OPTIONS.map((opt) => (
            <option key={opt.value} value={opt.value}>
              {opt.label}
            </option>
          ))}
        </select>
        <span className="text-sm text-slate-500">
          {data?.total.toLocaleString() ?? 0} resumes
        </span>
      </div>

      {/* Table */}
      <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-slate-200/60 bg-slate-50/50">
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  User
                </th>
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Status
                </th>
                <th className="text-center text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Attempts
                </th>
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Error
                </th>
                <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Updated
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {loading ? (
                Array.from({ length: 5 }).map((_, i) => (
                  <tr key={i}>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-40" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-20" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-12 mx-auto" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-32" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-16 ml-auto" />
                    </td>
                  </tr>
                ))
              ) : !data || data.resumes.length === 0 ? (
                <tr>
                  <td colSpan={5} className="px-4 py-8 text-center text-slate-500">
                    No resumes found
                  </td>
                </tr>
              ) : (
                data.resumes.map((resume) => (
                  <>
                    <tr
                      key={resume.id}
                      className={`hover:bg-slate-50/50 transition-colors ${
                        resume.status === "failed" ? "bg-red-50/30" : ""
                      }`}
                    >
                      <td className="px-4 py-3 text-sm text-slate-900">
                        {resume.userEmail}
                      </td>
                      <td className="px-4 py-3">
                        <ResumeStatusBadge status={resume.status} />
                      </td>
                      <td
                        className="px-4 py-3 text-center text-sm text-slate-600"
                        style={{ fontVariantNumeric: "tabular-nums" }}
                      >
                        {resume.retryCount}/3
                      </td>
                      <td className="px-4 py-3">
                        {resume.lastAttemptError ? (
                          <button
                            type="button"
                            onClick={() =>
                              setExpandedRow(
                                expandedRow === resume.id ? null : resume.id,
                              )
                            }
                            className="text-sm text-red-600 hover:text-red-800 truncate max-w-[200px] block text-left"
                            title="Click to expand"
                          >
                            {resume.lastAttemptError.slice(0, 50)}
                            {resume.lastAttemptError.length > 50 ? "..." : ""}
                          </button>
                        ) : (
                          <span className="text-sm text-slate-400">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-right text-sm text-slate-500">
                        {formatRelativeTime(resume.updatedAt)}
                      </td>
                    </tr>
                    {expandedRow === resume.id && resume.lastAttemptError && (
                      <tr key={`${resume.id}-error`}>
                        <td colSpan={5} className="px-4 py-3 bg-red-50/50">
                          <pre className="text-xs text-red-700 font-mono whitespace-pre-wrap wrap-break-word">
                            {resume.lastAttemptError}
                          </pre>
                        </td>
                      </tr>
                    )}
                  </>
                ))
              )}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="border-t border-slate-200/60 px-4 py-3">
            <Pagination
              currentPage={page}
              totalPages={totalPages}
              onPageChange={(p) => updateParams({ page: p })}
            />
          </div>
        )}
      </div>
    </div>
  );
}
```

**Step 3: Verify build**

Run: `bun run type-check && bun run lint`

Expected: No errors.

**Step 4: Commit**

```bash
git add app/\(admin\)/admin/resumes/ components/admin/ResumeStatusBadge.tsx
git commit -m "$(cat <<'EOF'
feat(admin): add resumes page with status filtering

- Clickable stat cards to filter by status
- Expandable error details for failed resumes
- Status badges with color coding
- URL-synced filtering and pagination
EOF
)"
```

---

## Task 10: Admin Analytics API

**Files:**
- Create: `app/api/admin/analytics/route.ts`

**Step 1: Create analytics API route**

Create `app/api/admin/analytics/route.ts`:

```typescript
/**
 * GET /api/admin/analytics?period=7d|30d|90d
 *
 * Returns platform-wide traffic analytics.
 */

import { getCloudflareContext } from "@opennextjs/cloudflare";
import { count, gte, sql } from "drizzle-orm";
import { requireAdminAuthForApi } from "@/lib/auth/admin";
import { getDb } from "@/lib/db";
import { pageViews, user } from "@/lib/db/schema";

export const runtime = "edge";

const VALID_PERIODS = new Set(["7d", "30d", "90d"]);

function periodToDays(period: string): number {
  switch (period) {
    case "30d":
      return 30;
    case "90d":
      return 90;
    default:
      return 7;
  }
}

export async function GET(request: Request) {
  const { error } = await requireAdminAuthForApi();
  if (error) return error;

  const url = new URL(request.url);
  const period = url.searchParams.get("period") || "7d";

  if (!VALID_PERIODS.has(period)) {
    return Response.json({ error: "Invalid period" }, { status: 400 });
  }

  try {
    const { env } = await getCloudflareContext({ async: true });
    const db = getDb(env.DB);

    const days = periodToDays(period);
    const sinceDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
    const prevPeriodStart = new Date(Date.now() - days * 2 * 24 * 60 * 60 * 1000).toISOString();

    const [
      currentTotals,
      prevTotals,
      daily,
      topProfiles,
      referrers,
      countries,
      devices,
    ] = await Promise.all([
      // Current period totals
      db
        .select({
          views: count(),
          unique: sql<number>`COUNT(DISTINCT ${pageViews.visitorHash})`,
          profiles: sql<number>`COUNT(DISTINCT ${pageViews.userId})`,
        })
        .from(pageViews)
        .where(gte(pageViews.createdAt, sinceDate)),

      // Previous period totals (for comparison)
      db
        .select({
          views: count(),
          unique: sql<number>`COUNT(DISTINCT ${pageViews.visitorHash})`,
        })
        .from(pageViews)
        .where(
          sql`${pageViews.createdAt} >= ${prevPeriodStart} AND ${pageViews.createdAt} < ${sinceDate}`,
        ),

      // Daily breakdown
      db
        .select({
          date: sql<string>`DATE(${pageViews.createdAt})`.as("date"),
          views: count(),
          unique: sql<number>`COUNT(DISTINCT ${pageViews.visitorHash})`,
        })
        .from(pageViews)
        .where(gte(pageViews.createdAt, sinceDate))
        .groupBy(sql`DATE(${pageViews.createdAt})`)
        .orderBy(sql`DATE(${pageViews.createdAt})`),

      // Top 10 profiles by views
      db
        .select({
          userId: pageViews.userId,
          views: count(),
          handle: user.handle,
        })
        .from(pageViews)
        .leftJoin(user, sql`${pageViews.userId} = ${user.id}`)
        .where(gte(pageViews.createdAt, sinceDate))
        .groupBy(pageViews.userId, user.handle)
        .orderBy(sql`COUNT(*) DESC`)
        .limit(10),

      // Top referrers
      db
        .select({
          referrer: pageViews.referrer,
          count: count(),
        })
        .from(pageViews)
        .where(
          sql`${pageViews.createdAt} >= ${sinceDate} AND ${pageViews.referrer} IS NOT NULL`,
        )
        .groupBy(pageViews.referrer)
        .orderBy(sql`COUNT(*) DESC`)
        .limit(10),

      // Countries
      db
        .select({
          country: pageViews.country,
          count: count(),
        })
        .from(pageViews)
        .where(
          sql`${pageViews.createdAt} >= ${sinceDate} AND ${pageViews.country} IS NOT NULL`,
        )
        .groupBy(pageViews.country)
        .orderBy(sql`COUNT(*) DESC`)
        .limit(10),

      // Devices
      db
        .select({
          device: pageViews.deviceType,
          count: count(),
        })
        .from(pageViews)
        .where(gte(pageViews.createdAt, sinceDate))
        .groupBy(pageViews.deviceType)
        .orderBy(sql`COUNT(*) DESC`),
    ]);

    const totalViews = currentTotals[0]?.views ?? 0;
    const prevViews = prevTotals[0]?.views ?? 0;
    const totalUnique = currentTotals[0]?.unique ?? 0;
    const prevUnique = prevTotals[0]?.unique ?? 0;

    // Calculate percentage changes
    const viewsChange = prevViews > 0 ? Math.round(((totalViews - prevViews) / prevViews) * 100) : 0;
    const uniqueChange = prevUnique > 0 ? Math.round(((totalUnique - prevUnique) / prevUnique) * 100) : 0;
    const avgPerDay = Math.round(totalViews / days);
    const prevAvgPerDay = Math.round(prevViews / days);
    const avgChange = prevAvgPerDay > 0 ? Math.round(((avgPerDay - prevAvgPerDay) / prevAvgPerDay) * 100) : 0;

    // Fill missing dates
    const filledDaily = fillMissingDates(daily, days);

    // Calculate percentages for breakdowns
    const totalReferrer = referrers.reduce((sum, r) => sum + r.count, 0);
    const totalCountry = countries.reduce((sum, c) => sum + c.count, 0);
    const totalDevice = devices.reduce((sum, d) => sum + d.count, 0);

    return Response.json({
      totals: {
        views: totalViews,
        unique: totalUnique,
        avgPerDay,
        profilesViewed: currentTotals[0]?.profiles ?? 0,
      },
      changes: {
        views: viewsChange,
        unique: uniqueChange,
        avgPerDay: avgChange,
      },
      daily: filledDaily,
      topProfiles: topProfiles.map((p) => ({
        handle: p.handle || "unknown",
        views: p.views,
      })),
      referrers: referrers.map((r) => ({
        domain: r.referrer || "unknown",
        count: r.count,
        percent: totalReferrer > 0 ? Math.round((r.count / totalReferrer) * 100) : 0,
      })),
      countries: countries.map((c) => ({
        code: c.country || "unknown",
        name: c.country || "Unknown",
        percent: totalCountry > 0 ? Math.round((c.count / totalCountry) * 100) : 0,
      })),
      devices: devices.map((d) => ({
        type: d.device || "unknown",
        percent: totalDevice > 0 ? Math.round((d.count / totalDevice) * 100) : 0,
      })),
    });
  } catch (err) {
    console.error("[admin/analytics] Error:", err);
    return Response.json({ error: "Failed to fetch analytics" }, { status: 500 });
  }
}

function fillMissingDates(
  data: Array<{ date: string; views: number; unique: number }>,
  days: number,
): Array<{ date: string; views: number; unique: number }> {
  const dataMap = new Map(data.map((d) => [d.date, d]));
  const result: Array<{ date: string; views: number; unique: number }> = [];

  for (let i = days - 1; i >= 0; i--) {
    const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
    const existing = dataMap.get(date);
    result.push(existing ?? { date, views: 0, unique: 0 });
  }

  return result;
}
```

**Step 2: Verify TypeScript compiles**

Run: `bun run type-check`

Expected: No errors.

**Step 3: Commit**

```bash
git add app/api/admin/analytics/
git commit -m "$(cat <<'EOF'
feat(api): add admin analytics endpoint

Platform-wide traffic analytics with period comparison.
Includes top profiles, referrers, countries, devices.
EOF
)"
```

---

## Task 11: Analytics Page

**Files:**
- Create: `app/(admin)/admin/analytics/page.tsx`
- Create: `components/admin/AdminTrafficChart.tsx`
- Create: `components/admin/HorizontalBarChart.tsx`

**Step 1: Create AdminTrafficChart component**

Create `components/admin/AdminTrafficChart.tsx`:

```typescript
"use client";

import { useEffect, useRef, useState } from "react";
import uPlot from "uplot";
import "uplot/dist/uPlot.min.css";

interface AdminTrafficChartProps {
  data: Array<{ date: string; views: number; unique: number }>;
}

export function AdminTrafficChart({ data }: AdminTrafficChartProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const chartRef = useRef<uPlot | null>(null);
  const [width, setWidth] = useState(0);

  useEffect(() => {
    const el = containerRef.current;
    if (!el) return;

    const ro = new ResizeObserver((entries) => {
      for (const entry of entries) {
        if (entry.contentRect.width > 0) {
          setWidth(Math.floor(entry.contentRect.width));
        }
      }
    });
    ro.observe(el);
    return () => ro.disconnect();
  }, []);

  useEffect(() => {
    const el = containerRef.current;
    if (!el || width <= 0 || data.length === 0) return;

    if (chartRef.current) {
      chartRef.current.destroy();
      chartRef.current = null;
    }

    const timestamps = data.map((d) => new Date(`${d.date}T00:00:00`).getTime() / 1000);
    const views = data.map((d) => d.views);
    const unique = data.map((d) => d.unique);

    const opts: uPlot.Options = {
      width,
      height: 200,
      padding: [12, 8, 0, 0],
      legend: {
        show: true,
        live: false,
      },
      cursor: {
        drag: { x: false, y: false, setScale: false },
      },
      series: [
        {},
        {
          label: "Views",
          stroke: "#6366f1",
          width: 2,
          fill: "rgba(99, 102, 241, 0.1)",
          paths: uPlot.paths.spline?.() ?? undefined,
        },
        {
          label: "Unique",
          stroke: "#10b981",
          width: 2,
          dash: [4, 4],
          paths: uPlot.paths.spline?.() ?? undefined,
        },
      ],
      axes: [
        {
          stroke: "#94a3b8",
          font: "11px system-ui, sans-serif",
          grid: { stroke: "rgba(0,0,0,0.05)", width: 1 },
          ticks: { show: false },
          values: (_self: uPlot, ticks: number[]) =>
            ticks.map((t) => {
              const d = new Date(t * 1000);
              return `${d.getMonth() + 1}/${d.getDate()}`;
            }),
        },
        {
          stroke: "#94a3b8",
          font: "11px system-ui, sans-serif",
          grid: { stroke: "rgba(0,0,0,0.05)", width: 1 },
          ticks: { show: false },
        },
      ],
    };

    chartRef.current = new uPlot(opts, [timestamps, views, unique], el);

    return () => {
      if (chartRef.current) {
        chartRef.current.destroy();
        chartRef.current = null;
      }
    };
  }, [width, data]);

  return <div ref={containerRef} className="w-full" style={{ height: 200 }} />;
}
```

**Step 2: Create HorizontalBarChart component**

Create `components/admin/HorizontalBarChart.tsx`:

```typescript
interface BarItem {
  label: string;
  value: number;
  percent: number;
}

interface HorizontalBarChartProps {
  items: BarItem[];
  colorClass?: string;
}

export function HorizontalBarChart({
  items,
  colorClass = "bg-indigo-500",
}: HorizontalBarChartProps) {
  if (items.length === 0) {
    return <p className="text-sm text-slate-400">No data available</p>;
  }

  return (
    <div className="space-y-2">
      {items.map((item) => (
        <div key={item.label} className="flex items-center gap-3">
          <span className="text-sm text-slate-600 w-32 truncate" title={item.label}>
            {item.label}
          </span>
          <div className="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div
              className={`h-full ${colorClass} rounded-full transition-all duration-300`}
              style={{ width: `${Math.max(item.percent, 2)}%` }}
            />
          </div>
          <span
            className="text-sm text-slate-900 font-medium w-12 text-right"
            style={{ fontVariantNumeric: "tabular-nums" }}
          >
            {item.percent}%
          </span>
        </div>
      ))}
    </div>
  );
}
```

**Step 3: Create Analytics page**

Create `app/(admin)/admin/analytics/page.tsx`:

```typescript
"use client";

import { BarChart3, Eye, TrendingUp, Users } from "lucide-react";
import Link from "next/link";
import { useCallback, useEffect, useState } from "react";
import { AdminTrafficChart } from "@/components/admin/AdminTrafficChart";
import { HorizontalBarChart } from "@/components/admin/HorizontalBarChart";
import { StatCard } from "@/components/admin/StatCard";
import { Skeleton } from "@/components/ui/skeleton";

type Period = "7d" | "30d" | "90d";

interface AnalyticsData {
  totals: {
    views: number;
    unique: number;
    avgPerDay: number;
    profilesViewed: number;
  };
  changes: {
    views: number;
    unique: number;
    avgPerDay: number;
  };
  daily: Array<{ date: string; views: number; unique: number }>;
  topProfiles: Array<{ handle: string; views: number }>;
  referrers: Array<{ domain: string; count: number; percent: number }>;
  countries: Array<{ code: string; name: string; percent: number }>;
  devices: Array<{ type: string; percent: number }>;
}

const PERIOD_OPTIONS: Array<{ value: Period; label: string }> = [
  { value: "7d", label: "7d" },
  { value: "30d", label: "30d" },
  { value: "90d", label: "90d" },
];

const COUNTRY_FLAGS: Record<string, string> = {
  US: "\u{1F1FA}\u{1F1F8}",
  GB: "\u{1F1EC}\u{1F1E7}",
  DE: "\u{1F1E9}\u{1F1EA}",
  CA: "\u{1F1E8}\u{1F1E6}",
  IN: "\u{1F1EE}\u{1F1F3}",
  FR: "\u{1F1EB}\u{1F1F7}",
  AU: "\u{1F1E6}\u{1F1FA}",
  BR: "\u{1F1E7}\u{1F1F7}",
  JP: "\u{1F1EF}\u{1F1F5}",
  MX: "\u{1F1F2}\u{1F1FD}",
};

export default function AdminAnalyticsPage() {
  const [data, setData] = useState<AnalyticsData | null>(null);
  const [loading, setLoading] = useState(true);
  const [period, setPeriod] = useState<Period>("7d");

  const fetchAnalytics = useCallback(async (p: Period) => {
    setLoading(true);
    try {
      const res = await fetch(`/api/admin/analytics?period=${p}`);
      if (!res.ok) throw new Error("Failed to fetch");
      const json: AnalyticsData = await res.json();
      setData(json);
    } catch (err) {
      console.error("Failed to fetch analytics:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchAnalytics(period);
  }, [period, fetchAnalytics]);

  return (
    <div className="space-y-6">
      {/* Period Toggle */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <BarChart3 className="w-5 h-5 text-slate-400" aria-hidden="true" />
          <span className="text-sm text-slate-500">Platform Analytics</span>
        </div>
        <div className="flex gap-1 bg-slate-100 rounded-lg p-0.5">
          {PERIOD_OPTIONS.map((opt) => (
            <button
              key={opt.value}
              type="button"
              onClick={() => setPeriod(opt.value)}
              className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${
                period === opt.value
                  ? "bg-white text-slate-900 shadow-sm"
                  : "text-slate-500 hover:text-slate-700"
              }`}
            >
              {opt.label}
            </button>
          ))}
        </div>
      </div>

      {/* Stat Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        {loading ? (
          Array.from({ length: 4 }).map((_, i) => (
            <Skeleton key={i} className="h-24 rounded-2xl" />
          ))
        ) : (
          <>
            <StatCard
              title="Total Views"
              value={data?.totals.views ?? 0}
              icon={Eye}
              iconColorClass="text-indigo-600"
              iconBgClass="bg-linear-to-r from-indigo-100 to-blue-100"
              change={data?.changes.views}
            />
            <StatCard
              title="Unique Visitors"
              value={data?.totals.unique ?? 0}
              icon={Users}
              iconColorClass="text-emerald-600"
              iconBgClass="bg-linear-to-r from-emerald-100 to-teal-100"
              change={data?.changes.unique}
            />
            <StatCard
              title="Avg/Day"
              value={data?.totals.avgPerDay ?? 0}
              icon={TrendingUp}
              iconColorClass="text-amber-600"
              iconBgClass="bg-linear-to-r from-amber-100 to-orange-100"
              change={data?.changes.avgPerDay}
            />
            <StatCard
              title="Profiles Viewed"
              value={data?.totals.profilesViewed ?? 0}
              icon={BarChart3}
              iconColorClass="text-purple-600"
              iconBgClass="bg-linear-to-r from-purple-100 to-pink-100"
            />
          </>
        )}
      </div>

      {/* Traffic Chart */}
      <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
        <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
          Platform Traffic
        </h2>
        {loading ? (
          <Skeleton className="h-[200px] rounded-lg" />
        ) : data ? (
          <AdminTrafficChart data={data.daily} />
        ) : null}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Top Profiles */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Top Profiles
          </h2>
          {loading ? (
            <div className="space-y-2">
              {Array.from({ length: 5 }).map((_, i) => (
                <Skeleton key={i} className="h-6" />
              ))}
            </div>
          ) : data?.topProfiles.length === 0 ? (
            <p className="text-sm text-slate-400">No profile views yet</p>
          ) : (
            <div className="space-y-2">
              {data?.topProfiles.map((profile, i) => (
                <div key={profile.handle} className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <span className="text-sm text-slate-400 w-6">{i + 1}.</span>
                    <Link
                      href={`/${profile.handle}`}
                      target="_blank"
                      className="text-sm text-indigo-600 hover:text-indigo-800"
                    >
                      @{profile.handle}
                    </Link>
                  </div>
                  <span
                    className="text-sm font-medium text-slate-900"
                    style={{ fontVariantNumeric: "tabular-nums" }}
                  >
                    {profile.views.toLocaleString()}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Traffic Sources */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Traffic Sources
          </h2>
          {loading ? (
            <div className="space-y-2">
              {Array.from({ length: 5 }).map((_, i) => (
                <Skeleton key={i} className="h-6" />
              ))}
            </div>
          ) : (
            <HorizontalBarChart
              items={
                data?.referrers.map((r) => ({
                  label: r.domain,
                  value: r.count,
                  percent: r.percent,
                })) ?? []
              }
              colorClass="bg-indigo-500"
            />
          )}
        </div>

        {/* Countries */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Top Countries
          </h2>
          {loading ? (
            <div className="space-y-2">
              {Array.from({ length: 5 }).map((_, i) => (
                <Skeleton key={i} className="h-6" />
              ))}
            </div>
          ) : data?.countries.length === 0 ? (
            <p className="text-sm text-slate-400">No country data yet</p>
          ) : (
            <div className="space-y-2">
              {data?.countries.map((c) => (
                <div key={c.code} className="flex items-center justify-between">
                  <span className="text-sm text-slate-600">
                    {COUNTRY_FLAGS[c.code] || "\u{1F3F3}"} {c.name}
                  </span>
                  <span
                    className="text-sm font-medium text-slate-900"
                    style={{ fontVariantNumeric: "tabular-nums" }}
                  >
                    {c.percent}%
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Devices */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Devices
          </h2>
          {loading ? (
            <div className="space-y-2">
              {Array.from({ length: 3 }).map((_, i) => (
                <Skeleton key={i} className="h-6" />
              ))}
            </div>
          ) : (
            <HorizontalBarChart
              items={
                data?.devices.map((d) => ({
                  label: d.type.charAt(0).toUpperCase() + d.type.slice(1),
                  value: 0,
                  percent: d.percent,
                })) ?? []
              }
              colorClass="bg-amber-500"
            />
          )}
        </div>
      </div>
    </div>
  );
}
```

**Step 4: Verify build**

Run: `bun run type-check && bun run lint`

Expected: No errors.

**Step 5: Commit**

```bash
git add app/\(admin\)/admin/analytics/ components/admin/AdminTrafficChart.tsx components/admin/HorizontalBarChart.tsx
git commit -m "$(cat <<'EOF'
feat(admin): add analytics page with traffic charts

- Period toggle (7d/30d/90d) with comparison stats
- uPlot traffic chart with views and unique visitors
- Top profiles, traffic sources, countries, devices
- Horizontal bar charts for breakdowns
EOF
)"
```

---

## Task 12: Admin Referrals API

**Files:**
- Create: `app/api/admin/referrals/route.ts`

**Step 1: Create referrals API route**

Create `app/api/admin/referrals/route.ts`:

```typescript
/**
 * GET /api/admin/referrals
 *
 * Returns referral program statistics.
 */

import { getCloudflareContext } from "@opennextjs/cloudflare";
import { count, desc, eq, gt, sql } from "drizzle-orm";
import { requireAdminAuthForApi } from "@/lib/auth/admin";
import { getDb } from "@/lib/db";
import { referralClicks, user } from "@/lib/db/schema";

export const runtime = "edge";

export async function GET() {
  const { error } = await requireAdminAuthForApi();
  if (error) return error;

  try {
    const { env } = await getCloudflareContext({ async: true });
    const db = getDb(env.DB);

    const [
      referrerCount,
      clickStats,
      sourceBreakdown,
      topReferrers,
      recentConversions,
    ] = await Promise.all([
      // Count users with at least 1 referral
      db
        .select({ count: count() })
        .from(user)
        .where(gt(user.referralCount, 0)),

      // Click and conversion stats
      db
        .select({
          totalClicks: count(),
          uniqueClicks: sql<number>`COUNT(DISTINCT ${referralClicks.visitorHash})`,
          conversions: sql<number>`SUM(CASE WHEN ${referralClicks.converted} = 1 THEN 1 ELSE 0 END)`,
        })
        .from(referralClicks),

      // Source breakdown
      db
        .select({
          source: referralClicks.source,
          count: count(),
        })
        .from(referralClicks)
        .groupBy(referralClicks.source)
        .orderBy(sql`COUNT(*) DESC`),

      // Top referrers by conversions
      db
        .select({
          userId: user.id,
          handle: user.handle,
          referralCount: user.referralCount,
        })
        .from(user)
        .where(gt(user.referralCount, 0))
        .orderBy(desc(user.referralCount))
        .limit(20),

      // Recent conversions
      db
        .select({
          id: referralClicks.id,
          referrerUserId: referralClicks.referrerUserId,
          convertedUserId: referralClicks.convertedUserId,
          createdAt: referralClicks.createdAt,
        })
        .from(referralClicks)
        .where(eq(referralClicks.converted, true))
        .orderBy(sql`${referralClicks.createdAt} DESC`)
        .limit(10),
    ]);

    // Get referrer handles and click counts for top referrers
    const referrerIds = topReferrers.map((r) => r.userId);
    const clickCounts =
      referrerIds.length > 0
        ? await db
            .select({
              referrerUserId: referralClicks.referrerUserId,
              clicks: count(),
            })
            .from(referralClicks)
            .where(
              sql`${referralClicks.referrerUserId} IN (${sql.join(
                referrerIds.map((id) => sql`${id}`),
                sql`, `,
              )})`,
            )
            .groupBy(referralClicks.referrerUserId)
        : [];

    const clickCountMap = new Map(clickCounts.map((c) => [c.referrerUserId, c.clicks]));

    // Get user details for recent conversions
    const conversionUserIds = [
      ...new Set([
        ...recentConversions.map((c) => c.referrerUserId),
        ...recentConversions.filter((c) => c.convertedUserId).map((c) => c.convertedUserId!),
      ]),
    ];

    const conversionUsers =
      conversionUserIds.length > 0
        ? await db
            .select({ id: user.id, email: user.email, handle: user.handle })
            .from(user)
            .where(
              sql`${user.id} IN (${sql.join(
                conversionUserIds.map((id) => sql`${id}`),
                sql`, `,
              )})`,
            )
        : [];

    const userMap = new Map(conversionUsers.map((u) => [u.id, u]));

    // Calculate stats
    const totalClicks = clickStats[0]?.totalClicks ?? 0;
    const uniqueClicks = clickStats[0]?.uniqueClicks ?? 0;
    const conversions = clickStats[0]?.conversions ?? 0;
    const conversionRate = uniqueClicks > 0 ? ((conversions / uniqueClicks) * 100).toFixed(1) : "0";

    // Calculate source percentages
    const totalSourceClicks = sourceBreakdown.reduce((sum, s) => sum + s.count, 0);

    return Response.json({
      stats: {
        totalReferrers: referrerCount[0]?.count ?? 0,
        totalClicks,
        conversions,
        conversionRate: Number.parseFloat(conversionRate),
      },
      funnel: {
        clicks: totalClicks,
        unique: uniqueClicks,
        signups: conversions,
      },
      topReferrers: topReferrers.map((r) => ({
        handle: r.handle || "unknown",
        clicks: clickCountMap.get(r.userId) ?? 0,
        conversions: r.referralCount,
        rate:
          (clickCountMap.get(r.userId) ?? 0) > 0
            ? ((r.referralCount / (clickCountMap.get(r.userId) ?? 1)) * 100).toFixed(1)
            : "0",
      })),
      sources: sourceBreakdown.map((s) => ({
        source: s.source || "unknown",
        percent: totalSourceClicks > 0 ? Math.round((s.count / totalSourceClicks) * 100) : 0,
      })),
      recentConversions: recentConversions.map((c) => ({
        newUserEmail: userMap.get(c.convertedUserId!)?.email ?? "Unknown",
        referrerHandle: userMap.get(c.referrerUserId)?.handle ?? "unknown",
        createdAt: c.createdAt,
      })),
    });
  } catch (err) {
    console.error("[admin/referrals] Error:", err);
    return Response.json({ error: "Failed to fetch referrals" }, { status: 500 });
  }
}
```

**Step 2: Verify TypeScript compiles**

Run: `bun run type-check`

Expected: No errors.

**Step 3: Commit**

```bash
git add app/api/admin/referrals/
git commit -m "$(cat <<'EOF'
feat(api): add admin referrals endpoint

Referral program stats: funnel, top referrers,
source breakdown, recent conversions.
EOF
)"
```

---

## Task 13: Referrals Page

**Files:**
- Create: `app/(admin)/admin/referrals/page.tsx`
- Create: `components/admin/FunnelChart.tsx`

**Step 1: Create FunnelChart component**

Create `components/admin/FunnelChart.tsx`:

```typescript
interface FunnelStep {
  label: string;
  value: number;
}

interface FunnelChartProps {
  steps: FunnelStep[];
}

export function FunnelChart({ steps }: FunnelChartProps) {
  if (steps.length === 0) return null;

  const maxValue = Math.max(...steps.map((s) => s.value));

  return (
    <div className="space-y-3">
      {steps.map((step, i) => {
        const width = maxValue > 0 ? (step.value / maxValue) * 100 : 0;

        return (
          <div key={step.label} className="flex items-center gap-4">
            <span className="text-sm text-slate-600 w-20">{step.label}</span>
            <div className="flex-1 h-8 bg-slate-100 rounded-full overflow-hidden">
              <div
                className="h-full bg-coral rounded-full transition-all duration-500 flex items-center justify-end pr-3"
                style={{ width: `${Math.max(width, 5)}%` }}
              >
                <span
                  className="text-sm font-medium text-white"
                  style={{ fontVariantNumeric: "tabular-nums" }}
                >
                  {step.value.toLocaleString()}
                </span>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
```

**Step 2: Create Referrals page**

Create `app/(admin)/admin/referrals/page.tsx`:

```typescript
"use client";

import { MousePointerClick, Share2, TrendingUp, UserPlus } from "lucide-react";
import Link from "next/link";
import { useCallback, useEffect, useState } from "react";
import { FunnelChart } from "@/components/admin/FunnelChart";
import { HorizontalBarChart } from "@/components/admin/HorizontalBarChart";
import { StatCard } from "@/components/admin/StatCard";
import { Skeleton } from "@/components/ui/skeleton";

interface ReferralsData {
  stats: {
    totalReferrers: number;
    totalClicks: number;
    conversions: number;
    conversionRate: number;
  };
  funnel: {
    clicks: number;
    unique: number;
    signups: number;
  };
  topReferrers: Array<{
    handle: string;
    clicks: number;
    conversions: number;
    rate: string;
  }>;
  sources: Array<{ source: string; percent: number }>;
  recentConversions: Array<{
    newUserEmail: string;
    referrerHandle: string;
    createdAt: string;
  }>;
}

function formatRelativeTime(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffHours / 24);

  if (diffHours < 1) return "just now";
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

const MEDAL_EMOJIS = ["\u{1F947}", "\u{1F948}", "\u{1F949}"];

export default function AdminReferralsPage() {
  const [data, setData] = useState<ReferralsData | null>(null);
  const [loading, setLoading] = useState(true);

  const fetchReferrals = useCallback(async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/admin/referrals");
      if (!res.ok) throw new Error("Failed to fetch");
      const json: ReferralsData = await res.json();
      setData(json);
    } catch (err) {
      console.error("Failed to fetch referrals:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchReferrals();
  }, [fetchReferrals]);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-2">
        <Share2 className="w-5 h-5 text-slate-400" aria-hidden="true" />
        <span className="text-sm text-slate-500">Referral Program</span>
      </div>

      {/* Stat Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        {loading ? (
          Array.from({ length: 4 }).map((_, i) => (
            <Skeleton key={i} className="h-24 rounded-2xl" />
          ))
        ) : (
          <>
            <StatCard
              title="Total Referrers"
              value={data?.stats.totalReferrers ?? 0}
              icon={Share2}
              iconColorClass="text-purple-600"
              iconBgClass="bg-linear-to-r from-purple-100 to-pink-100"
            />
            <StatCard
              title="Total Clicks"
              value={data?.stats.totalClicks ?? 0}
              icon={MousePointerClick}
              iconColorClass="text-indigo-600"
              iconBgClass="bg-linear-to-r from-indigo-100 to-blue-100"
            />
            <StatCard
              title="Conversions"
              value={data?.stats.conversions ?? 0}
              icon={UserPlus}
              iconColorClass="text-emerald-600"
              iconBgClass="bg-linear-to-r from-emerald-100 to-teal-100"
            />
            <StatCard
              title="Conv. Rate"
              value={`${data?.stats.conversionRate ?? 0}%`}
              icon={TrendingUp}
              iconColorClass="text-amber-600"
              iconBgClass="bg-linear-to-r from-amber-100 to-orange-100"
            />
          </>
        )}
      </div>

      {/* Funnel */}
      <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
        <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
          Referral Funnel
        </h2>
        {loading ? (
          <div className="space-y-3">
            {Array.from({ length: 3 }).map((_, i) => (
              <Skeleton key={i} className="h-8" />
            ))}
          </div>
        ) : data ? (
          <FunnelChart
            steps={[
              { label: "Clicks", value: data.funnel.clicks },
              { label: "Unique", value: data.funnel.unique },
              { label: "Signups", value: data.funnel.signups },
            ]}
          />
        ) : null}
      </div>

      {/* Top Referrers Table */}
      <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 overflow-hidden">
        <div className="p-6 border-b border-slate-200/60">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider">
            Top Referrers
          </h2>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-slate-200/60 bg-slate-50/50">
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Rank
                </th>
                <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  User
                </th>
                <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Clicks
                </th>
                <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Conversions
                </th>
                <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3">
                  Rate
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {loading ? (
                Array.from({ length: 5 }).map((_, i) => (
                  <tr key={i}>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-8" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-24" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-12 ml-auto" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-12 ml-auto" />
                    </td>
                    <td className="px-4 py-3">
                      <Skeleton className="h-5 w-12 ml-auto" />
                    </td>
                  </tr>
                ))
              ) : !data || data.topReferrers.length === 0 ? (
                <tr>
                  <td colSpan={5} className="px-4 py-8 text-center text-slate-500">
                    No referrers yet
                  </td>
                </tr>
              ) : (
                data.topReferrers.map((referrer, i) => (
                  <tr key={referrer.handle} className="hover:bg-slate-50/50 transition-colors">
                    <td className="px-4 py-3 text-sm">
                      {i < 3 ? (
                        <span className="text-lg">{MEDAL_EMOJIS[i]}</span>
                      ) : (
                        <span className="text-slate-400 pl-1">{i + 1}</span>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      <Link
                        href={`/${referrer.handle}`}
                        target="_blank"
                        className="text-sm text-indigo-600 hover:text-indigo-800"
                      >
                        @{referrer.handle}
                      </Link>
                    </td>
                    <td
                      className="px-4 py-3 text-right text-sm text-slate-900"
                      style={{ fontVariantNumeric: "tabular-nums" }}
                    >
                      {referrer.clicks.toLocaleString()}
                    </td>
                    <td
                      className="px-4 py-3 text-right text-sm text-slate-900 font-medium"
                      style={{ fontVariantNumeric: "tabular-nums" }}
                    >
                      {referrer.conversions}
                    </td>
                    <td
                      className="px-4 py-3 text-right text-sm text-slate-600"
                      style={{ fontVariantNumeric: "tabular-nums" }}
                    >
                      {referrer.rate}%
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Click Sources */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Click Sources
          </h2>
          {loading ? (
            <div className="space-y-2">
              {Array.from({ length: 3 }).map((_, i) => (
                <Skeleton key={i} className="h-6" />
              ))}
            </div>
          ) : (
            <HorizontalBarChart
              items={
                data?.sources.map((s) => ({
                  label: s.source.charAt(0).toUpperCase() + s.source.slice(1),
                  value: 0,
                  percent: s.percent,
                })) ?? []
              }
              colorClass="bg-purple-500"
            />
          )}
        </div>

        {/* Recent Conversions */}
        <div className="bg-white rounded-2xl shadow-depth-sm border border-slate-200/60 p-6">
          <h2 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">
            Recent Conversions
          </h2>
          {loading ? (
            <div className="space-y-3">
              {Array.from({ length: 5 }).map((_, i) => (
                <Skeleton key={i} className="h-10" />
              ))}
            </div>
          ) : data?.recentConversions.length === 0 ? (
            <p className="text-sm text-slate-400">No conversions yet</p>
          ) : (
            <div className="space-y-3">
              {data?.recentConversions.map((conv, i) => (
                <div
                  key={`${conv.newUserEmail}-${i}`}
                  className="flex items-center justify-between text-sm"
                >
                  <div className="min-w-0 flex-1">
                    <span className="text-slate-600 truncate block">
                      {conv.newUserEmail}
                    </span>
                    <span className="text-slate-400">
                      via{" "}
                      <Link
                        href={`/${conv.referrerHandle}`}
                        target="_blank"
                        className="text-indigo-600 hover:text-indigo-800"
                      >
                        @{conv.referrerHandle}
                      </Link>
                    </span>
                  </div>
                  <span className="text-xs text-slate-400 shrink-0 ml-2">
                    {formatRelativeTime(conv.createdAt)}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

**Step 3: Verify build**

Run: `bun run type-check && bun run lint`

Expected: No errors.

**Step 4: Commit**

```bash
git add app/\(admin\)/admin/referrals/ components/admin/FunnelChart.tsx
git commit -m "$(cat <<'EOF'
feat(admin): add referrals page with funnel and leaderboard

- Funnel visualization (clicks  unique  signups)
- Top referrers table with medals for top 3
- Click sources breakdown
- Recent conversions list
EOF
)"
```

---

## Task 14: Add Admin Link to User Dashboard

**Files:**
- Modify: `components/dashboard/Sidebar.tsx`

**Step 1: Add admin link to sidebar**

Read the file first, then add the admin link after the "View Site" link and before the logout button.

Add this import at the top:

```typescript
import { Shield } from "lucide-react";
```

Add after the "View Site" link section (around line 232), before the logout `</nav>` closing tag:

```typescript
          {/* Admin Link - only show if user is admin */}
          {/* Note: isAdmin check happens via API on dashboard load */}
```

Actually, we need to check if user is admin. The sidebar doesn't have access to this info currently. We need to add it.

**Revised approach:** Add isAdmin to the profile fetch and conditionally render.

In `components/dashboard/Sidebar.tsx`:

1. Update the `UserProfile` interface:

```typescript
interface UserProfile {
  handle: string | null;
  isAdmin: boolean;
}
```

2. Update the `ProfileResponse` interface:

```typescript
interface ProfileResponse {
  handle?: string | null;
  isAdmin?: boolean;
}
```

3. Update the `loadProfile` function to include isAdmin:

```typescript
setProfile({ handle: data.handle ?? null, isAdmin: data.isAdmin ?? false });
```

4. Add the Shield import at the top.

5. Add admin link after "View Site" link:

```typescript
          {/* Admin Link */}
          {profile?.isAdmin && (
            <button
              type="button"
              onClick={() => {
                router.push("/admin");
                onClose?.();
              }}
              className="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-purple-700 hover:bg-purple-50 transition-all duration-300"
            >
              <Shield size={20} />
              <span>Admin</span>
            </button>
          )}
```

**Step 2: Update profile API to include isAdmin**

Modify `app/api/profile/me/route.ts` to include `isAdmin` in the response.

**Step 3: Verify build**

Run: `bun run type-check && bun run lint`

Expected: No errors.

**Step 4: Test locally**

Run: `bun run dev`

Visit `/dashboard` - admin link should appear for admin users.

**Step 5: Commit**

```bash
git add components/dashboard/Sidebar.tsx app/api/profile/me/route.ts
git commit -m "$(cat <<'EOF'
feat(ui): add admin link to user dashboard sidebar

Shows Admin link with Shield icon for admin users.
Link navigates to /admin dashboard.
EOF
)"
```

---

## Task 15: Final Integration & Testing

**Step 1: Run full type check**

Run: `bun run type-check`

Expected: No errors.

**Step 2: Run linter**

Run: `bun run lint`

Expected: No errors.

**Step 3: Run knip for unused exports**

Run: `bunx knip`

Expected: No critical issues.

**Step 4: Build check**

Run: `bun run build`

Expected: Build succeeds.

**Step 5: Manual testing checklist**

1. Set yourself as admin: `bunx wrangler d1 execute webresume-db --local --command "UPDATE user SET is_admin = 1 WHERE email = 'your@email.com'"`
2. Visit `/dashboard` - verify Admin link appears
3. Click Admin link - verify redirect to `/admin`
4. Test each page: Overview, Users, Resumes, Analytics, Referrals
5. Test mobile sidebar (resize browser)
6. Test search on Users page
7. Test status filter on Resumes page
8. Test period toggle on Analytics page
9. Verify "Back to Dashboard" returns to user dashboard

**Step 6: Final commit**

```bash
git add .
git commit -m "$(cat <<'EOF'
feat(admin): complete admin dashboard implementation

Read-only admin dashboard with:
- Overview: stats cards, recent signups, 7-day sparkline
- Users: paginated list with search, status badges
- Resumes: status filtering, error details, retry counts
- Analytics: traffic charts, top profiles, referrers, devices
- Referrals: funnel, leaderboard, conversion tracking

Protected by isAdmin flag on user table.
Matches existing Neubrutalist design system.
EOF
)"
```

---

## Summary

**Total Tasks:** 15
**Estimated Implementation:** ~3-4 hours

**Files Created:**
- `lib/auth/admin.ts`
- `app/(admin)/admin/layout.tsx`
- `app/(admin)/admin/layout-client.tsx`
- `app/(admin)/admin/page.tsx`
- `app/(admin)/admin/users/page.tsx`
- `app/(admin)/admin/resumes/page.tsx`
- `app/(admin)/admin/analytics/page.tsx`
- `app/(admin)/admin/referrals/page.tsx`
- `app/api/admin/stats/route.ts`
- `app/api/admin/users/route.ts`
- `app/api/admin/resumes/route.ts`
- `app/api/admin/analytics/route.ts`
- `app/api/admin/referrals/route.ts`
- `components/admin/AdminSidebar.tsx`
- `components/admin/AdminHeader.tsx`
- `components/admin/StatCard.tsx`
- `components/admin/AdminSparkline.tsx`
- `components/admin/UserStatusBadge.tsx`
- `components/admin/ResumeStatusBadge.tsx`
- `components/admin/Pagination.tsx`
- `components/admin/AdminTrafficChart.tsx`
- `components/admin/HorizontalBarChart.tsx`
- `components/admin/FunnelChart.tsx`

**Files Modified:**
- `lib/db/schema.ts` (add isAdmin)
- `components/dashboard/Sidebar.tsx` (add admin link)
- `app/api/profile/me/route.ts` (include isAdmin)
